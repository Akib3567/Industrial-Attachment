@model IEnumerable<Cuet_Bus_Booking_System.Models.BookingDetails>

<div class="container mt-4">
    <div class="section-title">My Bookings</div>

    <div class="mb-3">
        <label for="busFilter" class="form-label fw-semibold">Filter by Bus</label>
        <select id="busFilter" class="form-select" style="max-width: 300px;">
            <option value="">All Buses</option>
            @foreach (var bus in Model.Select(b => b.BusName).Distinct())
            {
                <option value="@bus">@bus</option>
            }
        </select>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table mb-0 align-middle" id="bookingTable">
                <thead class="table-light">
                    <tr>
                        <th>Bus Name</th>
                        <th>Student Name</th>
                        <th>Student ID</th>
                        <th>Seat No.</th>
                        <th>Date</th>
                        <th>Schedule</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var booking in Model)
                        {
                            <tr data-bus="@booking.BusName">
                                <td>@booking.BusName</td>
                                <td>John Doe</td>
                                <td>@booking.UserId</td>
                                <td>@booking.SeatNumber</td>
                                <td>@booking.BookingDate.ToString("yyyy-MM-dd")</td>
                                <td>@booking.ScheduleTime</td>
                                <td>
                                    <button class="btn btn-sm btn-danger cancel-booking-btn" data-booking-id="@booking.BookingId">
                                        Cancel
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr id="noBookingsRow">
                            <td colspan="7" class="text-center py-4">No bookings found</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .container {
        background: white;
        padding: 26px;
        margin: 20px auto;
        max-width: 1200px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
    }

    .section-title {
        font-size: 24px;
        margin-bottom: 20px;
        font-weight: 600;
    }
</style>

<script>
    const busFilter = document.getElementById('busFilter');
    const bookingTable = document.getElementById('bookingTable');

    if (busFilter) {
        busFilter.addEventListener('change', function () {
            const selectedBus = this.value.toLowerCase();
            const rows = bookingTable.querySelectorAll('tbody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                if (row.id === 'noBookingsRow') return;

                const busName = row.dataset.bus.toLowerCase();

                if (selectedBus === '' || busName === selectedBus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            const noBookingsRow = document.getElementById('noBookingsRow');
            if (noBookingsRow) {
                noBookingsRow.style.display = visibleCount === 0 ? '' : 'none';
            } else if (visibleCount === 0) {
                const tbody = bookingTable.querySelector('tbody');
                const newRow = tbody.insertRow();
                newRow.id = 'noBookingsRow';
                newRow.innerHTML = '<td colspan="7" class="text-center py-4">No bookings found for selected bus</td>';
            }
        });
    }

    document.querySelectorAll('.cancel-booking-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const bookingId = this.dataset.bookingId;

            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }

            try {
                const response = await fetch(`/User/CancelBooking?bookingId=${bookingId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Booking cancelled successfully!');

                    const row = this.closest('tr');
                    row.remove();

                    const remainingRows = bookingTable.querySelectorAll('tbody tr:not(#noBookingsRow)');
                    if (remainingRows.length === 0) {
                        const tbody = bookingTable.querySelector('tbody');
                        const noBookingsRow = document.createElement('tr');
                        noBookingsRow.id = 'noBookingsRow';
                        noBookingsRow.innerHTML = '<td colspan="7" class="text-center py-4">No bookings found</td>';
                        tbody.appendChild(noBookingsRow);
                    }

                    const currentFilter = busFilter.value;
                    if (currentFilter) {
                        busFilter.dispatchEvent(new Event('change'));
                    }
                } else {
                    alert('Failed to cancel booking. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while cancelling the booking.');
            }
        });
    });
</script>