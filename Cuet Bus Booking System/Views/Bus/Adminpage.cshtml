@model IEnumerable<Cuet_Bus_Booking_System.Models.CuetBus>

@{
    ViewData["Title"] = "CUET Bus Management";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><strong>CUET Bus Management</strong></h3>
        <a href="/logout" class="text-decoration-none">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </div>

    <p>Welcome, <strong>Admin User</strong></p>

    <div class="btn-group mb-4" role="group">
        <button class="btn btn-primary" id="manageBusesBtn">Manage Buses</button>
        <button class="btn btn-outline-primary" id="viewBookingsBtn">View Bookings</button>
    </div>

    <div id="manageBusesSection">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Bus Management</h5>
            <button class="btn btn-success" id="showAddFormBtn">
                <i class="bi bi-plus-lg"></i> Add Bus
            </button>
        </div>

        <div class="card mb-4 d-none" id="addBusForm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Add New Bus</h5>
                    <button class="btn-close" id="closeAddFormBtn"></button>
                </div>

                <form id="addBusFormData">
                    <div class="mb-3">
                        <label class="form-label">Bus Name</label>
                        <input type="text" id="busName" name="busName" class="form-control" placeholder="Enter Bus Name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total Seats</label>
                        <input type="number" id="totalSeats" name="totalSeats" class="form-control" placeholder="Enter Total Seats" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedule</label>
                        <input type="text" id="scheduleTime" name="scheduleTime" class="form-control" placeholder="e.g., 8:00 AM - Campus to City" required>
                    </div>

                    <div class="d-flex">
                        <button type="button" class="btn btn-primary w-50 me-2" id="addBusBtn">Add Bus</button>
                        <button type="button" class="btn btn-secondary w-50" id="cancelAddBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4 d-none" id="editBusForm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Edit Bus</h5>
                    <button class="btn-close" id="closeEditFormBtn"></button>
                </div>

                <form id="editBusFormData">
                    <input type="hidden" id="editBusId">
                    <div class="mb-3">
                        <label class="form-label">Bus Name</label>
                        <input type="text" id="editBusName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total Seats</label>
                        <input type="number" id="editBusSeats" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedule</label>
                        <input type="text" id="editBusSchedule" class="form-control" required>
                    </div>

                    <div class="d-flex">
                        <button type="button" class="btn btn-primary w-50 me-2" id="updateBusBtn">Update Bus</button>
                        <button type="button" class="btn btn-secondary w-50" id="cancelEditBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="busList">
            @foreach (var bus in Model)
            {
                <div class="card mb-3 shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">@bus.BusName</h5>
                            <p class="mb-0 text-muted">Total Seats: @bus.TotalSeats</p>
                            <small>@bus.ScheduleTime</small>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2 edit-btn"
                                    data-id="@bus.BusId"
                                    data-name="@bus.BusName"
                                    data-seats="@bus.TotalSeats"
                                    data-schedule="@bus.ScheduleTime">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm delete-btn"
                                    data-id="@bus.BusId"
                                    data-name="@bus.BusName">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div id="viewBookingsSection" style="display: none;"></div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

@section Scripts {
    <script>
        const addForm = document.getElementById("addBusForm");
        const editForm = document.getElementById("editBusForm");
        const showAddFormBtn = document.getElementById("showAddFormBtn");
        const closeAddFormBtn = document.getElementById("closeAddFormBtn");
        const cancelAddBtn = document.getElementById("cancelAddBtn");
        const closeEditFormBtn = document.getElementById("closeEditFormBtn");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const manageBusesBtn = document.getElementById("manageBusesBtn");
        const viewBookingsBtn = document.getElementById("viewBookingsBtn");
        const manageBusesSection = document.getElementById("manageBusesSection");
        const viewBookingsSection = document.getElementById("viewBookingsSection");

        manageBusesBtn.addEventListener("click", () => {
            manageBusesBtn.classList.remove("btn-outline-primary");
            manageBusesBtn.classList.add("btn-primary");
            viewBookingsBtn.classList.remove("btn-primary");
            viewBookingsBtn.classList.add("btn-outline-primary");
            manageBusesSection.style.display = "block";
            viewBookingsSection.style.display = "none";
        });

        viewBookingsBtn.addEventListener("click", async () => {
            viewBookingsBtn.classList.remove("btn-outline-primary");
            viewBookingsBtn.classList.add("btn-primary");
            manageBusesBtn.classList.remove("btn-primary");
            manageBusesBtn.classList.add("btn-outline-primary");
            manageBusesSection.style.display = "none";
            viewBookingsSection.style.display = "block";

            try {
                const response = await fetch('/Bus/GetAllBookings');
                const html = await response.text();
                viewBookingsSection.innerHTML = html;
            } catch (error) {
                console.error('Error loading bookings:', error);
                viewBookingsSection.innerHTML = '<div class="alert alert-danger">Error loading bookings</div>';
            }
        });

        showAddFormBtn.addEventListener("click", () => {
            addForm.classList.remove("d-none");
            editForm.classList.add("d-none");
        });

        [closeAddFormBtn, cancelAddBtn].forEach(btn => {
            btn.addEventListener("click", () => addForm.classList.add("d-none"));
        });

        [closeEditFormBtn, cancelEditBtn].forEach(btn => {
            btn.addEventListener("click", () => editForm.classList.add("d-none"));
        });

        document.getElementById("addBusBtn").addEventListener("click", async () => {
            const busName = document.getElementById("busName").value.trim();
            const totalSeats = document.getElementById("totalSeats").value;
            const scheduleTime = document.getElementById("scheduleTime").value.trim();

            if (!busName || !totalSeats || !scheduleTime) {
                alert("Please fill in all fields");
                return;
            }

            const busData = {
                BusName: busName,
                TotalSeats: parseInt(totalSeats),
                ScheduleTime: scheduleTime
            };

            try {
                const response = await fetch('/Bus/AddBus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(busData)
                });

                if (response.ok) {
                    alert("Bus added successfully!");
                    document.getElementById("addBusFormData").reset();
                    addForm.classList.add("d-none");
                    location.reload();
                } else {
                    alert("Failed to add bus. Please try again.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while adding the bus.");
            }
        });

        document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const id = btn.dataset.id;
                const name = btn.dataset.name;
                const seats = btn.dataset.seats;
                const schedule = btn.dataset.schedule;

                document.getElementById("editBusId").value = id;
                document.getElementById("editBusName").value = name;
                document.getElementById("editBusSeats").value = seats;
                document.getElementById("editBusSchedule").value = schedule;

                addForm.classList.add("d-none");
                editForm.classList.remove("d-none");
            });
        });

        document.getElementById("updateBusBtn").addEventListener("click", async () => {
            const busId = document.getElementById("editBusId").value;
            const busName = document.getElementById("editBusName").value.trim();
            const totalSeats = document.getElementById("editBusSeats").value;
            const scheduleTime = document.getElementById("editBusSchedule").value.trim();

            if (!busName || !totalSeats || !scheduleTime) {
                alert("Please fill in all fields");
                return;
            }

            const busData = {
                BusId: parseInt(busId),
                BusName: busName,
                TotalSeats: parseInt(totalSeats),
                ScheduleTime: scheduleTime
            };

            try {
                const response = await fetch('/Bus/UpdateBus', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(busData)
                });

                if (response.ok) {
                    alert("Bus updated successfully!");
                    editForm.classList.add("d-none");
                    location.reload();
                } else {
                    alert("Failed to update bus. Please try again.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while updating the bus.");
            }
        });

        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", async (e) => {
                const busId = btn.dataset.id;
                const busName = btn.dataset.name;

                if (!confirm(`Are you sure you want to delete ${busName}?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/Bus/DeleteBus/${busId}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        alert("Bus deleted successfully!");
                        location.reload();
                    } else {
                        alert("Failed to delete bus. Please try again.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("An error occurred while deleting the bus.");
                }
            });
        });
    </script>
}